<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡€åœ§ãƒ‡ãƒ¼ã‚¿ã®ã‚°ãƒ©ãƒ•</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <h1>è¡€åœ§ã®æ¨ç§»</h1>
    <button id="updateChartBtn" class="btn">ãƒ‡ãƒ¼ã‚¿æ›´æ–°</button>
    <canvas id="bloodPressureChart" style="width: 600px; height: 300px;"></canvas>
    <a href="/">ğŸ”™ è¡€åœ§è¨˜éŒ²ã®ä¸€è¦§ã«æˆ»ã‚‹</a>
    <label for="startDate">é–‹å§‹æ—¥:</label>
    <input type="date" id="startDate">
    <label for="endDate">çµ‚äº†æ—¥:</label>
    <input type="date" id="endDate">
    <button id="filterChartBtn">æœŸé–“ã§è¡¨ç¤º</button>
    <canvas id="bloodPressureChart"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const ctx = document.getElementById("bloodPressureChart").getContext("2d");
    
            function fetchLast30DaysData(chart) {
                fetch("/chart-data")
                    .then(response => response.json())
                    .then(data => {
                        if (data.length === 0) {
                            alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼");
                            return;
                        }
    
                        updateChart(chart, data);
                    });
            }
    
            function fetchFilteredData(chart) {
                const startDate = document.getElementById("startDate").value;
                const endDate = document.getElementById("endDate").value;
                // ã“ã“ã§ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ­ã‚°ã‚’è¿½åŠ ã—ã¾ã™
                console.log(`ã€DEBUGã€‘é–‹å§‹æ—¥: ${startDate}, çµ‚äº†æ—¥: ${endDate}`);  // âœ… ã“ã“ã‚’è¿½åŠ ï¼

                if (!startDate || !endDate) {
                    alert("é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
                    return;
                }
    
                fetch(`/chart-data?start=${startDate}&end=${endDate}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length === 0) {
                            alert("æŒ‡å®šã•ã‚ŒãŸæœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼");
                            return;
                        }
    
                        updateChart(chart, data);
                    });
            }
    
            function updateChart(chart, data) {
                const labels = data.map(item => item.date);
                const systolicData = data.map(item => item.systolic);
                const diastolicData = data.map(item => item.diastolic);
    
                chart.data.labels = labels;
                chart.data.datasets[0].data = systolicData;
                chart.data.datasets[1].data = diastolicData;
                chart.update();
            }
    
            const bloodPressureChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: "åç¸®æœŸè¡€åœ§ (systolic)",
                            data: [],
                            borderColor: "red",
                            fill: false
                        },
                        {
                            label: "æ‹¡å¼µæœŸè¡€åœ§ (diastolic)",
                            data: [],
                            borderColor: "blue",
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });
    
            fetchLast30DaysData(bloodPressureChart);
    
            document.getElementById("updateChartBtn").addEventListener("click", function() {
                fetchLast30DaysData(bloodPressureChart);
            });
    
            document.getElementById("filterChartBtn").addEventListener("click", function() {
                fetchFilteredData(bloodPressureChart);
            });
        });
    </script>
</body>
</html>